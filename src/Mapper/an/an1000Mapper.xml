<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
	PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
    
<mapper namespace="an1000Mapper">
	<select id="an1000InfoSel" parameterType="map" resultType="map">
		SELECT USER_ID,
			   HOLIDAY_TOTAL,
			   HOLIDAY_USE,
			   HOLIDAY_REMAIN,
			   HOLIDAY_DEDUCT,
			   REG_DT
		FROM HOLIDAY_INFO
		WHERE USER_ID LIKE #{USER_ID}
	</select>

	<select id="an1000InfoSelUsers" parameterType="map" resultType="map">
		SELECT A.USER_ID,
			   A.HOLIDAY_TOTAL,
			   A.HOLIDAY_USE,
			   A.HOLIDAY_REMAIN,
			   A.HOLIDAY_DEDUCT,
			   A.REG_DT
		  FROM HOLIDAY_INFO A
			   LEFT OUTER JOIN USER_INFO B ON A.USER_ID = B.USER_ID
		 WHERE B.USER_NM LIKE '%' + #{USER_NM} + '%'
	</select>

	<select id="an1000Sel" parameterType="map" resultType="map">
		SELECT H.USER_ID,
			   U.USER_NM,
			   U.GRADE_CD,
			   (SELECT SYS_ITEM_NAME FROM SYSCODE_DETAIL WHERE SYS_CLASS_CD LIKE 'ROLE' AND SYS_ITEM_CD LIKE U.GRADE_CD) AS GRADE_NM,
			   (SELECT SYS_ITEM_NAME FROM SYSCODE_DETAIL WHERE SYS_CLASS_CD LIKE 'HOLIDAY' AND SYS_ITEM_CD LIKE H.HOLIDAY_TYPE) AS HOLIDAY_TYPE,
			   H.HOLIDAY_CNT,
			   H.HOLIDAY_START,
			   H.HOLIDAY_END,
			   H.HOLIDAY_REASON,
			   H.TASK,
			   H.ACQUIRER,
			   H.EMERGENCY
		FROM HOLIDAY_PERSON H
				 LEFT OUTER JOIN USER_INFO U ON H.USER_ID = U.USER_ID
		WHERE H.USE_YN = 'Y'
		    <choose>
				<when test='USER_ID != Null and !USER_ID.equals("")'>
					AND H.USER_ID = #{USER_ID}
				</when>
		    	<otherwise>
					AND U.USER_NM LIKE '%' + #{USER_NM} + '%'
					AND CONVERT(DATE, H.HOLIDAY_START) BETWEEN #{START} AND #{END}
		  			<if test='TYPE != Null and !TYPE.equals("")'>
						AND H.HOLIDAY_TYPE LIKE #{TYPE}
					</if>
				</otherwise>
			</choose>
		ORDER BY H.HOLIDAY_START DESC
	</select>

	<insert id="an1000Save" parameterType="map">
		INSERT INTO HOLIDAY_PERSON (USER_ID, HOLIDAY_TYPE, HOLIDAY_CNT,
		                            HOLIDAY_START, HOLIDAY_END, HOLIDAY_REASON,
		                            TASK, ACQUIRER, EMERGENCY,
		                            REG_ID, REG_DT,USE_YN
		                            )
							VALUES (#{USER_ID}, #{HOLIDAY_TYPE}, #{HOLIDAY_CNT},
							        #{HOLIDAY_START}, #{HOLIDAY_END}, #{HOLIDAY_REASON},
							        #{TASK}, #{ACQUIRER}, #{EMERGENCY},
							        #{REG_ID}, GETDATE(), 'Y')
	</insert>

	<update id="an1000Update" parameterType="map">
		UPDATE HOLIDAY_PERSON SET UPT_DT = GETDATE(), UPT_ID = #{UPT_ID}, USE_YN = 'N'
		                      WHERE	USER_ID = #{USER_ID} AND
		                          	HOLIDAY_START = #{HOLIDAY_START} AND
		                          	HOLIDAY_END = #{HOLIDAY_END} AND
		                          	HOLIDAY_CNT = #{HOLIDAY_CNT} AND
		                          	HOLIDAY_REASON = #{HOLIDAY_REASON} AND
		                          	HOLIDAY_TYPE = #{HOLIDAY_TYPE} AND
									USE_YN = 'Y'
	</update>

	<select id="an1000HolidayOfficeSel" resultType="String">
		SELECT MIN(OFFICE_HOLIDAY) FROM HOLIDAY_OFFICE
		                           WHERE DATEPART(MONTH, CONVERT(DATE, OFFICE_HOLIDAY)) = DATEPART(MONTH, CONVERT(DATE, GETDATE()))
	</select>

	<select id="an1000HolidayOfficeByUser" resultType="Integer">
		DECLARE @HOLIDAY VARCHAR(10) = (SELECT MIN(hc.OFFICE_HOLIDAY) AS companyday FROM HOLIDAY_OFFICE hc WHERE DATEPART(MONTH, CONVERT(DATE, hc.OFFICE_HOLIDAY)) = DATEPART(MONTH, CONVERT(DATE, getdate())))
		SELECT COUNT(*) FROM HOLIDAY_PERSON WHERE USER_ID = #{USER_ID} AND HOLIDAY_START = @HOLIDAY AND HOLIDAY_END = @HOLIDAY AND HOLIDAY_TYPE IN ('OFFICE01', 'OFFICE02')
	</select>

	<resultMap id="holidayInfo" type="com.hs.an.dto.HolidayInfoDto">
		<result property="user_id" column="USER_ID"/>
		<result property="holiday_total" column="HOLIDAY_TOTAL"/>
		<result property="holiday_use" column="HOLIDAY_USE"/>
		<result property="holiday_remain" column="HOLIDAY_REMAIN"/>
		<result property="holiday_deduct" column="HOLIDAY_DEDUCT"/>
	</resultMap>

	<select id="an1000HolidayInfoSel" parameterType="String" resultMap="holidayInfo">
		SELECT USER_ID, HOLIDAY_TOTAL, HOLIDAY_USE, HOLIDAY_REMAIN, HOLIDAY_DEDUCT FROM HOLIDAY_INFO WHERE USER_ID = #{USER_ID}
	</select>

	<update id="an1000HolidayInfoUpdate" parameterType="com.hs.an.dto.HolidayInfoDto">
		UPDATE HOLIDAY_INFO SET HOLIDAY_TOTAL = #{holiday_total},
		                        HOLIDAY_USE = #{holiday_use},
		                        HOLIDAY_REMAIN = #{holiday_remain},
		                        HOLIDAY_DEDUCT = #{holiday_deduct}
		WHERE USER_ID = #{user_id}
	</update>

	<select id="an1000PrintByUser" parameterType="com.hs.an.dto.An1000PrintDto" resultType="map">
		SELECT U.USER_ID,
			   U.USER_NM,
			   (SELECT D.DEPT_NAME FROM DEPT_INFO D WHERE D.DEPT_ID = U.DEPT_CD) AS DEPT_NM,
			   (SELECT SYS_ITEM_NAME FROM SYSCODE_DETAIL WHERE SYS_CLASS_CD LIKE 'ROLE' AND SYS_ITEM_CD LIKE U.GRADE_CD) AS GRADE_NM,
			   H.TASK,
			   H.ACQUIRER,
			   (SELECT SYS_ITEM_NAME FROM SYSCODE_DETAIL WHERE SYS_CLASS_CD = 'HOLIDAY' AND SYS_ITEM_NAME LIKE #{holidayType}) AS HOLIDAY_TYPE,
			   H.HOLIDAY_START,
			   H.HOLIDAY_END,
			   H.HOLIDAY_CNT,
			   H.HOLIDAY_REASON,
			   H.ACQUIRER,
			   H.EMERGENCY,
			   H.REG_DT
		FROM USER_INFO U INNER JOIN HOLIDAY_PERSON H ON U.USER_ID = H.USER_ID
		WHERE U.USER_ID = #{userId}
		  AND H.USE_YN = 'Y'
		  AND (SELECT SYS_ITEM_NAME FROM SYSCODE_DETAIL WHERE SYS_CLASS_CD = 'HOLIDAY' AND SYS_ITEM_CD LIKE H.HOLIDAY_TYPE) LIKE #{holidayType}
		  AND H.HOLIDAY_START = #{holidayStart}
		  AND H.HOLIDAY_END = #{holidayEnd}
		  AND H.HOLIDAY_CNT = #{holidayCnt}
		  AND H.HOLIDAY_REASON = #{holidayReason}
	</select>

	<select id="an1000PublicHolidaySel" parameterType="map" resultType="string">
		SELECT PUBLIC_DAY FROM HOLIDAY_PUBLIC WHERE PUBLIC_DAY &gt;= #{startDate}
		<if test='endDate != Null and !endDate.equals("")'>
		AND PUBLIC_DAY &lt;= #{endDate}
		</if>
		ORDER BY PUBLIC_DAY
	</select>

	<insert id="an1000PublicHolidaySave" parameterType="java.util.List">
		INSERT INTO HOLIDAY_PUBLIC (PUBLIC_NAME, PUBLIC_DAY, REG_ID, REG_DT) VALUES
		<foreach collection="list" item="item" separator=", ">
			(#{item.publicName}, #{item.publicDay}, 'SYSTEM', GETDATE())
		</foreach>
	</insert>

	<select id="an1000SelUser" parameterType="map" resultType="map">
		SELECT A.USER_ID
			 , A.USER_NM
			 , A.PDEPT_CD
			 , (SELECT dbo.FN_COMMON_NM('DEPT', A.PDEPT_CD)) AS PDEPT_NM
			 , A.DEPT_CD
			 , (SELECT dbo.FN_COMMON_NM('DEPT', A.DEPT_CD)) AS DEPT_NM
			 , A.GRADE_CD
			 , (SELECT dbo.FN_COMMON_NM('ROLE', A.GRADE_CD)) AS GRADE_NM
			 , A.ENTER_DT
		  FROM USER_INFO A
		 WHERE A.USER_NM LIKE '%' + #{USER_NM} + '%'
		 ORDER BY A.USER_NM;
	</select>

</mapper>